<template>
    <!-- Main layout container -->
    <div class="main-layout">
        <!-- Left sidebar with search filters -->
        <div class="sidebar">
            <div class="slds-card slds-card_boundary search-container">
                <div class="slds-card__header">
                    <h2 class="slds-card__header-title">
                        <span class="slds-text-heading_medium">Search Filters</span>
                    </h2>
                </div>
                <div class="slds-card__body slds-card__body_inner">
                    <lightning-combobox
                        label="Location"
                        options={locations}
                        value={locationName}
                        onchange={handleLocationChange}
                        class="slds-m-bottom_large">
                    </lightning-combobox>
                    <lightning-combobox
                        label="Vehicle Model"
                        options={vehicleModels}
                        value={modelName}
                        onchange={handleModelChange}
                        class="slds-m-bottom_large">
                    </lightning-combobox>
                    <lightning-input
                        label="Start Date"
                        type="date"
                        value={startDate}
                        onchange={handleStartDateChange}
                        class="slds-m-bottom_large">
                    </lightning-input>
                    <lightning-input
                        label="End Date"
                        type="date"
                        value={endDate}
                        onchange={handleEndDateChange}
                        class="slds-m-bottom_large">
                    </lightning-input>
                    <lightning-button 
                        label="Search" 
                        onclick={handleSearch}
                        variant="brand"
                        class="slds-m-top_medium">
                    </lightning-button>
                </div>
            </div>
        </div>
        <!-- Lease Confirmation Panel -->
        <template if:true={showLeaseConfirmation}>
            <div class="lease-confirmation-panel">
                <div class="slds-card slds-card_boundary">
                    <div class="slds-card__header">
                        <h2 class="slds-card__header-title">
                            <span class="slds-text-heading_medium">Lease Confirmed!</span>
                        </h2>
                    </div>
                    <div class="slds-card__body slds-card__body_inner">
                        <p class="slds-text-heading_small slds-m-bottom_medium">
                            Lease Number: <strong>{leaseRecord.Name}</strong>
                        </p>
                        <p>Vehicle: {leaseRecord.VehicleName}</p>
                        <p>Contact: {leaseRecord.ContactName}</p>
                        <p>Start Date: {leaseRecord.StartDate}</p>
                        <p>End Date: {leaseRecord.EndDate}</p>
                        <div class="slds-m-top_medium">
                            <lightning-button label="Book Another Vehicle" onclick={handleBackToSearch}></lightning-button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        <!-- Main content area -->
        <template if:false={showLeaseConfirmation}>
        <div class="content-area">
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
            </template>

            <template if:true={error}>
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error error-message">
                    <p>{error.message}</p>
                </div>
            </template>

            <template if:true={vehicles.length}>
                <div class="slds-card slds-card_boundary">
                    <div class="slds-card__body slds-card__body_inner">
                        <div class="slds-text-heading_medium slds-text-align_center">
                            <lightning-icon icon-name="utility:car" size="small" class="slds-m-right_small"></lightning-icon>
                            {totalVehicles} Available Vehicles Found
                        </div>
                    </div>
                </div>
            </template>

            <template if:true={vehicles.length}>
                <div class="main-content">
                    <div class="vehicle-grid-section">
                        <div class="results-container">
                            <template for:each={paginatedVehicles} for:item="vehicle">
                                <div key={vehicle.VehicleId} class="slds-card_boundary vehicle-card">
                                    <div class="slds-card__body slds-card__body_inner">
                                        <lightning-formatted-rich-text 
                                            value={vehicle.CarImage} 
                                            class="lightning-formatted-rich-text">
                                        </lightning-formatted-rich-text>
                                        <h3 class="vehicle-name">{vehicle.VehicleName}</h3>
                                        <p class="vehicle-details">Location: {vehicle.LocationName}</p>
                                        <p class="vehicle-details">Hourly Rate: ${vehicle.HourlyRate}</p>
                                        <div class="slds-text-align_center">
                                            <span class={vehicle.vehicleStatusClass}>
                                                {vehicle.AvailabilityStatus}
                                            </span>
                                        </div>
                                        <div class="slds-text-align_center slds-m-top_medium">
                                            <lightning-button 
                                                label="Select Vehicle" 
                                                variant="neutral"
                                                onclick={handleVehicleSelect}
                                                data-vehicle-id={vehicle.VehicleId}>
                                            </lightning-button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div class="slds-card slds-card_boundary pagination-container">
                            <div class="slds-card__body slds-card__body_inner">
                                <lightning-button 
                                    label="Previous" 
                                    onclick={handlePrevious}
                                    disabled={isFirstPage}
                                    variant="neutral"
                                    class="slds-m-right_medium">
                                </lightning-button>
                                <span class="slds-m-horizontal_medium">Page {currentPage} of {totalPages}</span>
                                <lightning-button 
                                    label="Next" 
                                    onclick={handleNext}
                                    disabled={isLastPage}
                                    variant="neutral"
                                    class="slds-m-left_medium">
                                </lightning-button>
                            </div>
                        </div>
                    </div>

                    <template if:true={selectedVehicle}>
                        <div class="vehicle-details-panel">
                            <div class="slds-card slds-card_boundary">
                                <div class="slds-card__header">
                                    <h2 class="slds-card__header-title">
                                        <span class="slds-text-heading_medium">Selected Vehicle</span>
                                    </h2>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <div class="slds-media slds-media_center slds-m-bottom_medium">
                                        <div class="slds-media__figure">
                                            <lightning-formatted-rich-text 
                                                value={selectedVehicle.CarImage} 
                                                class="selected-vehicle-image">
                                            </lightning-formatted-rich-text>
                                        </div>
                                        <div class="slds-media__body">
                                            <h3 class="slds-text-heading_medium">{selectedVehicle.VehicleName}</h3>
                                            <p class="slds-text-body_regular">
                                                <lightning-icon icon-name="utility:location" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                                {selectedVehicle.LocationName}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="slds-m-bottom_medium">
                                        <h4 class="slds-text-heading_small slds-m-bottom_small">Rental Period</h4>
                                        <div class="slds-grid slds-grid_vertical">
                                            <div class="slds-col">
                                                <strong>Start Date:</strong> {formattedStartDate}
                                            </div>
                                            <div class="slds-col">
                                                <strong>End Date:</strong> {formattedEndDate}
                                            </div>
                                            <div class="slds-col">
                                                <strong>Duration:</strong> {rentalDuration} hours
                                            </div>
                                        </div>
                                    </div>

                                    <div class="slds-m-bottom_medium">
                                        <h4 class="slds-text-heading_small slds-m-bottom_small">Pricing Breakdown</h4>
                                        <div class="slds-grid slds-grid_vertical">
                                            <div class="slds-col slds-grid slds-grid_align-spread">
                                                <span>Hourly Rate:</span>
                                                <span>${selectedVehicle.HourlyRate}</span>
                                            </div>
                                            <div class="slds-col slds-grid slds-grid_align-spread">
                                                <span>Duration:</span>
                                                <span>{rentalDuration} hours</span>
                                            </div>
                                            <div class="slds-col slds-grid slds-grid_align-spread slds-text-heading_medium slds-text-color_success">
                                                <strong>Total Price:</strong>
                                                <strong>${totalPrice}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="slds-m-bottom_medium">
                                        <h4 class="slds-text-heading_small slds-m-bottom_small">Contact Information</h4>
                                        <div class="contact-search-container">
                                            <lightning-input
                                                label="Search Contact"
                                                type="text"
                                                value={contactSearchTerm}
                                                onchange={handleContactSearch}
                                                placeholder="Type at least 4 characters to search..."
                                                class="slds-m-bottom_small">
                                            </lightning-input>
                                            
                                            <!-- Contact search results dropdown -->
                                            <template if:true={showContactResults}>
                                                <div class="contact-results-dropdown">
                                                    <template if:true={isLoadingContacts}>
                                                        <div class="slds-text-align_center slds-p-around_medium">
                                                            <lightning-spinner size="small" alternative-text="Searching contacts..."></lightning-spinner>
                                                        </div>
                                                    </template>
                                                    
                                                    <template if:false={isLoadingContacts}>
                                                        <template if:true={contactSearchResults.length}>
                                                            <template for:each={contactSearchResults} for:item="contact">
                                                                <div key={contact.Id} 
                                                                    class="contact-result-item"
                                                                    onclick={handleContactSelect}
                                                                    data-contact-id={contact.Id}
                                                                    data-contact-name={contact.Name}>
                                                                    <div class="contact-info">
                                                                        <div class="contact-name">{contact.Name}</div>
                                                                        <div class="contact-email">{contact.Email}</div>
                                                                    </div>
                                                                </div>
                                                            </template>
                                                        </template>
                                                        
                                                        <template if:false={contactSearchResults.length}>
                                                            <div class="slds-text-align_center slds-p-around_medium slds-text-color_weak">
                                                                No contacts found
                                                            </div>
                                                        </template>
                                                    </template>
                                                </div>
                                            </template>
                                            
                                            <!-- Selected contact display -->
                                            <template if:true={selectedContact}>
                                                <div class="selected-contact">
                                                    <div class="slds-media slds-media_center">
                                                        <div class="slds-media__figure">
                                                            <lightning-icon icon-name="standard:contact" size="small"></lightning-icon>
                                                        </div>
                                                        <div class="slds-media__body">
                                                            <div class="contact-name">{selectedContact.Name}</div>
                                                            <div class="contact-email">{selectedContact.Email}</div>
                                                        </div>
                                                        <div class="slds-media__figure">
                                                            <lightning-button-icon
                                                                icon-name="utility:close"
                                                                variant="bare"
                                                                onclick={handleClearContact}
                                                                alternative-text="Clear selection">
                                                            </lightning-button-icon>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="slds-text-align_center">
                                        <lightning-button 
                                            label="Book This Vehicle" 
                                            variant="brand"
                                            onclick={handleBookVehicle}
                                            class="slds-m-right_small">
                                        </lightning-button>
                                        <lightning-button 
                                            label="Clear Selection" 
                                            variant="neutral"
                                            onclick={handleClearSelection}>
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="calendar-panel">
                            <div class="slds-card slds-card_boundary">
                                <div class="slds-card__header">
                                    <h2 class="slds-card__header-title">
                                        <span class="slds-text-heading_medium">Availability Calendar</span>
                                    </h2>
                                </div>
                                <div class="slds-card__body slds-card__body_inner">
                                    <lightning-button 
                                        label={calendarButtonLabel} 
                                        variant="neutral"
                                        onclick={handleToggleCalendar}
                                        class="slds-m-bottom_small">
                                    </lightning-button>
                                    
                                    <template if:true={showCalendarView}>
                                        <div class="calendar-container">
                                            <div class="calendar-header">
                                                <h5 class="slds-text-heading_small">{monthName}</h5>
                                            </div>
                                            <div class="calendar-grid">
                                                <!-- Day headers -->
                                                <template for:each={dayNames} for:item="day">
                                                    <div key={day} class="calendar-day-header">
                                                        {day}
                                                    </div>
                                                </template>
                                                
                                                <template for:each={calendarDates} for:item="calendarDate">
                                                    <div key={calendarDate.date} class={calendarDate.cssClass}>
                                                        <template if:true={calendarDate.date}>
                                                            <span class="calendar-date-text">
                                                                {calendarDate.displayDate}
                                                            </span>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                            
                                            <!-- Legend -->
                                            <div class="calendar-legend">
                                                <div class="legend-item">
                                                    <span class="legend-color available"></span>
                                                    <span>Available</span>
                                                </div>
                                                <div class="legend-item">
                                                    <span class="legend-color unavailable"></span>
                                                    <span>Unavailable</span>
                                                </div>
                                                <div class="legend-item">
                                                    <span class="legend-color today"></span>
                                                    <span>Today</span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>

            <template if:false={vehicles.length}>
                <template if:false={isLoading}>
                    <div class="slds-text-align_center slds-m-top_large">
                        <h3>No vehicles found</h3>
                        <p>Try adjusting your search criteria to find available vehicles.</p>
                    </div>
                </template>
            </template>
        </div>
        </template>
    </div>
</template>